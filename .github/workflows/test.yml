name: Run Selenium Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ui
          - api
          - internal
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean
      custom_flags:
        description: 'Additional test flags'
        required: false
        type: string

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Hatch
        run: pip install hatch
      
      # Make sure reports directories exist
      - name: Prepare directories
        run: |
          mkdir -p reports/allure-results
          mkdir -p reports/html
          mkdir -p reports/json
          mkdir -p reports/screenshots
          mkdir -p reports/allure-report
          chmod -R 777 reports
      
      # Setup Docker Buildx for improved caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Prepare cache directories
      - name: Prepare cache directories
        run: |
          mkdir -p /tmp/.buildx-cache
          mkdir -p /tmp/.buildx-cache-new
      
      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      # Build Docker image directly without registry login
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          load: true
          tags: testopus:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
      
      # Temp fix for actions/cache performance
      # https://github.com/docker/build-push-action/issues/252
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Run tests
        run: |
          if [ "${{ github.event.inputs.test_suite }}" = "ui" ]; then
            docker compose -f docker/docker-compose.yml run --rm testopus ui:web ${{ github.event.inputs.custom_flags }}
          elif [ "${{ github.event.inputs.test_suite }}" = "api" ]; then
            docker compose -f docker/docker-compose.yml run --rm testopus api:run ${{ github.event.inputs.custom_flags }}
          elif [ "${{ github.event.inputs.test_suite }}" = "internal" ]; then
            docker compose -f docker/docker-compose.yml run --rm testopus test:internal ${{ github.event.inputs.custom_flags }}
          else
            docker compose -f docker/docker-compose.yml run --rm testopus test:run-all-reports ${{ github.event.inputs.custom_flags }}
          fi
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode == 'true' }}
      
      - name: Clean up containers
        if: always()
        run: docker compose -f docker/docker-compose.yml down --remove-orphans
      
      # List report files to verify they exist
      - name: List reports directory
        if: always()
        run: |
          ls -la reports/
          ls -la reports/allure-results/ || echo "No allure-results directory"
          ls -la reports/html/ || echo "No html directory"
      
      # Install allure-commandline for report generation
      - name: Set up Allure
        if: always()
        run: |
          wget -O allure-commandline.zip https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.24.0/allure-commandline-2.24.0.zip
          unzip allure-commandline.zip
      
      # Generate Allure report
      - name: Generate Allure Report
        if: always()
        run: |
          if [ -d "reports/allure-results" ] && [ "$(ls -A reports/allure-results)" ]; then
            ./allure-2.24.0/bin/allure generate reports/allure-results -o reports/allure-report --clean
            echo "Allure report generated successfully"
          else
            echo "No Allure results found, skipping report generation"
            mkdir -p reports/allure-report
            echo "<html><body><h1>No test results available</h1></body></html>" > reports/allure-report/index.html
          fi
      
      # Upload test reports as artifacts
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            reports/html/
            reports/json/
            reports/screenshots/
            reports/allure-results/
            reports/allure-report/
            
      # Optional: Publish test results
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/json/report_*.json
          check_name: Test Results
      
      # Configure GitHub Pages
      - name: Setup Pages
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: actions/configure-pages@v4
      
      # Upload GitHub Pages artifact
      - name: Upload GitHub Pages artifact
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'reports/allure-report'
      
      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: deployment
        uses: actions/deploy-pages@v3
      
      # Comment on PR with link to reports
      - name: Comment PR with Report Links
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const artifactUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const pagesUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}`;
            
            const comment = `### Test Reports ðŸ“Š
            
            #### Report Links:
            - [Download Test Reports](${artifactUrl})
            - [View Allure Report](${pagesUrl}) (available after merge to main)
            
            *Tests run by GitHub Actions workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 